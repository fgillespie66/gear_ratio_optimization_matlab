function model = getHumanoidModel(fb_joint_type)
% This function builds the floating base model of the Humanoid robot
% using the conventions of the spatialv2 library

%% Robot Parameters
robot = struct(...
    'torso_mass',7.954054,...
    'torso_length',0.1,...
    'torso_width',0.164,...
    'torso_height',0.30392,...
    'torsoRotationalInertia',[0.168459, 0.000124, 0.006493,...
                            0.000124, 0.101358, 0.000278,...
                            0.006493, 0.000278, 0.091754],...
    'torso_COM',[0.009598, 0.000935, 0.151714],...
    'shoulderRyRotationalInertia',[0.001363, 0.000024, -0.000002,...
                                   0.000024, 0.000759,  0.000001,...
                                   -0.000002, 0.000001, 0.000866],...
    'shoulderRyCOM',[0.009518, 0.053027, 0.000060],...
    'shoulderRyMass',0.788506,...
    'shoulderRxRotationalInertia',[0.001136, 0.000001 , 0.000016,...
                                   0.000001, 0.001175,  0.000001,...
                                   0.000016, 0.000001, 0.001241],...
    'shoulderRxCOM',[0.000117, 0.000122, -0.082758],...
    'shoulderRxMass',0.801249,...
    'shoulderRzRotationalInertia',[0.001353, 0.000002,  0.000001,...
                                   0.000002,   0.001804, -0.000061,...
                                   0.000001, -0.000061, 0.000796],...
    'shoulderRzCOM',[-0.000073, -0.016471,  -0.063210],...
    'shoulderRzMass',0.905588,...
    'elbowRotationalInertia',[ 0.003400, 0.00000, -0.000049,...
                            0.00000, 0.003453, -0.000002,...
                           -0.000049, -0.000002, 0.000078],...
    'elbowCOM',[-0.007103, -0.000073, -0.099203],...
    'elbowMass',0.348390,...
    'hipRzRotationalInertia',[0.001502, 0.000004, 0.000533,...
                            0.000004, 0.001361, 0.000000,...
                            0.000533, 0.000000, 0.001170],...
    'hipRzCOM',[-0.065362,  -0.000128,  -0.063947],...
    'hipRzMass',0.842752,...
    'hipRxRotationalInertia',[0.001745, 0.000003, -0.000082,...
                            0.000003, 0.003338, -0.000010,...
                            -0.000082, -0.000010, 0.001951],...
    'hipRxCOM',[0.067579,  -0.013035, 0.000132],...
    'hipRxMass',1.199631,...
    'hipRyRotationalInertia',[0.024489, 0.000068, 0.000512,...
                            0.000068, 0.026049, 0.002657,...
                            0.000512, 0.002657, 0.003812],...
    'hipRyCOM',[-0.001100,  0.026032, -0.078842],...
    'hipRyMass',2.634789,...
    'kneeRotationalInertia',[0.002952, 0.000000, 0.000083,...
                           0.000000, 0.002943, 0.000033,...
                           0.000083, 0.000033, 0.000238],...
    'kneeCOM',[0.005232, 0.000457,  -0.131581],...
    'kneeMass',0.346291,...
    'ankleRotationalInertia',[ 0.000092, 0.000000, -0.000054,...
                            0.000000, 0.000806, -0.000000,...
                           -0.000054, -0.000000, 0.000769],...
    'ankleCOM',[0.022696, 0.0, -0.013879],...
    'ankleMass',0.279583,...
    'hipRzLocation',[0., -0.082, 0],...
    'hipRzPitch',-0.174533,...
    'hipRxLocation',[-0.06435, 0.0, -.07499],...
    'hipRxPitch',0.436332,...
    'hipRyLocation',[0.08837, 0.00284, -0.01385],...
    'hipRyPitch',-1*(0.436332 - 0.174533),... % hipRyPitch = -(hipRxPitch + hipRzPitch);
    'kneeLocation',[-0.01306, 0.0, -0.24916],...
    'ankleLocation',[0.0, 0.0, -0.2785],...    
    'shoulderRyLocation',[0.01911, -0.17608, 0.30392],...
    'shoulderRxLocation',[0.0, -0.05760, 0.0],...
    'shoulderRzLocation',[0.0, 0.0, -0.10250],...
    'elbowLocation',[0.0, 0.0, -0.15750],...
    'footToeLength',0.085,...
    'footHeelLength',0.05,...
    'footHeight',0.041,...
    'lowerArmLength',0.27,...
    'leg_rad',0.02,... % TODO what is this ?
    'shoulderGearRatio',6,...
    'elbowGearRatio',9.0,...
    'hipGearRatio',6,...
    'kneeGearRatio',12.0,...
    'ankleGearRatio',12.0,...
    'batteryV',60,...
    'smallMotorKT',0.1567,...
    'largeMotorKT',0.191,.....
    'smallMotorR',0.43,...
    'largeMotorR',0.158,...
    'smallMotorTauMax',33.6/6,...
    'largeMotorTauMax',68/6,...
    'smallMotorVelMax',330,...
    'largeMotorVelMax',270,...
    'smallMotorH',200*10e-6 /1.5,...
    'largeMotorH',83*10e-6 /1.5,...
    'smallMotorFlux',0.005,...
    'largeMotorFlux',0.006,...
    'hipSrbmLocation',[0.02 -0.1 0;0.02 0.1 0]);% TODO is this still used ? 
%% Add arm mass tip

robot = add_arm_tip_mass(0.0,robot); % adding mass on arm tip

%% Build the model
switch fb_joint_type
    case 'eul'
        model = buildHumanoidModel(robot);
        model.params  = robot;
        model = buildHumanoidShowMotion(model);
        model.appearance.base = {'tiles', [-10 20;-6 6;0 0], 0.4};
    case 'quat'
        error('spatial_v3 quaternion floating base model not ready yet')
    case 'SE3'
        error('spatial_v3 SE3 floating base model not ready yet')
    otherwise
        error('Invalid floating base joint type given')
end

model.fb_type = fb_joint_type;
model.params  = robot;
model.name    = 'Humanoid';

end

%% Helper function to add mass on tip of forearm

function params = add_arm_tip_mass(m_add,params)

L = [0 0 -params.lowerArmLength];
l = L - params.elbowCOM;
mtot = m_add + params.elbowMass;
params.elbowCOM = (params.elbowCOM*params.elbowMass +m_add*L)/mtot;

params.elbowMass  = mtot;
Ic = reshape(params.elbowRotationalInertia,3,3);
Ic = Ic+m_add*skew(l)*skew(l)';
params.elbowRotationalInertia = reshape(Ic,1,9);

end